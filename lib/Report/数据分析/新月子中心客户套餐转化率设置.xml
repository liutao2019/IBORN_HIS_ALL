<ReportQueryInfo Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.ReportQueryInfo,SOC.HISFC.OutpatientFee.Components"><List><List Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryControl,SOC.HISFC.OutpatientFee.Components"><Index>0</Index><Name>dtBeginTime</Name><Text>开始时间：</Text><IsAddText>true</IsAddText><ControlType Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.ControlType.DateTimeType,SOC.HISFC.OutpatientFee.Components"><AddDays>-1</AddDays><AddMonths>0</AddMonths><CustomFormat>yyyy-MM-dd</CustomFormat><DefaultDataSource></DefaultDataSource><Format>Custom</Format><IsLike>false</IsLike><LikeStr>%{0}%</LikeStr><Size Type="System.Drawing.Size,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Width>120</Width><Height>20</Height></Size><Location Type="System.Drawing.Point,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><X>10</X><Y>2</Y></Location><QueryDataSource>Dictionary</QueryDataSource><DataSourceTypeName></DataSourceTypeName><Enabled>true</Enabled></ControlType></List><List Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryControl,SOC.HISFC.OutpatientFee.Components"><Index>1</Index><Name>dtEndTime</Name><Text>结束时间：</Text><IsAddText>true</IsAddText><ControlType Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.ControlType.DateTimeType,SOC.HISFC.OutpatientFee.Components"><AddDays>0</AddDays><AddMonths>0</AddMonths><CustomFormat>yyyy-MM-dd</CustomFormat><DefaultDataSource></DefaultDataSource><Format>Custom</Format><IsLike>false</IsLike><LikeStr>%{0}%</LikeStr><Size Type="System.Drawing.Size,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Width>120</Width><Height>20</Height></Size><Location Type="System.Drawing.Point,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><X>220</X><Y>2</Y></Location><QueryDataSource>Dictionary</QueryDataSource><DataSourceTypeName></DataSourceTypeName><Enabled>true</Enabled></ControlType></List><List Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryControl,SOC.HISFC.OutpatientFee.Components"><Index>2</Index><Name>name</Name><Text>类型：</Text><IsAddText>true</IsAddText><ControlType Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.ControlType.ComboBoxType,SOC.HISFC.OutpatientFee.Components"><IsAddAll>true</IsAddAll><AllValue Type="FS.FrameWork.Models.NeuObject,FrameWork"><ID>ALL</ID><Name>全部</Name><Memo></Memo></AllValue><DataSource /><DefaultDataSource /><IsLike>false</IsLike><LikeStr>%{0}%</LikeStr><Size Type="System.Drawing.Size,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Width>120</Width><Height>20</Height></Size><Location Type="System.Drawing.Point,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><X>430</X><Y>2</Y></Location><QueryDataSource>Sql</QueryDataSource><DataSourceTypeName>select distinct case when cd.name like '%综%' then '综' when cd.code in ('25','6') then '医美' when cd.code in ('11','14','5','19') then '妇科' else replace(cd.name,'套餐','') end code,case when cd.name like '%综%' then '综' when cd.code in ('25','6') then '医美' when cd.code in ('11','14','5','19') then '妇科' else replace(cd.name,'套餐','') end name from com_dictionary cd where cd.type='PACKAGETYPE' and cd.code!='21'</DataSourceTypeName><Enabled>true</Enabled></ControlType></List></List><QueryDataSource><QueryDataSource Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryDataSource,SOC.HISFC.OutpatientFee.Components"><Name>dtDataSource</Name><Sql>select t11.* 
  from (
    select t7.name,
           t8.amount,
          sum(case when t9.type='第一个月/当月' then t9.amount else 0 end) 第一个月套餐购买人次,
          to_char(round(sum(case when t9.type='第一个月/当月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第一个月套餐购买率,
          sum(case when t9.type='第二个月' then t9.amount else 0 end) 第二个月套餐购买人次,
          to_char(round(sum(case when t9.type='第二个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第二个月套餐购买率,
          sum(case when t9.type='第三个月' then t9.amount else 0 end) 第三个月套餐购买人次,
          to_char(round(sum(case when t9.type='第三个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第三个月套餐购买率,
          sum(case when t9.type='第四个月' then t9.amount else 0 end) 第四个月套餐购买人次,
          to_char(round(sum(case when t9.type='第四个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第四个月套餐购买率,
          sum(case when t9.type='第五个月' then t9.amount else 0 end) 第五个月套餐购买人次,
          to_char(round(sum(case when t9.type='第五个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第五个月套餐购买率,
          sum(case when t9.type='第六个月' then t9.amount else 0 end) 第六个月套餐购买人次，
          to_char(round(sum(case when t9.type='第六个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第六个月套餐购买率
      from ( select distinct case when cd.code in ('11','14','5','19') then '妇科' 
                                  when cd.code in ('25'，'6') then '医美'
                                  when cd.code in ('7','8','9','10','22','23','24') then '综'
                                  else replace(cd.name,'套餐','') end name,'套餐' line
               from com_dictionary cd where cd.type='PACKAGETYPE' and cd.name not like '%代收%')t7 
      left join (select '套餐' line,count(f.card_no) amount
                   from fin_ipr_inmaininfo f 
                  where f.dept_code='1010'
                    and f.in_state&lt;&gt;'N'
                    and f.patient_no not like 'B%'
                    and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ) t8 on t7.line=t8.line
      left join (select  '第一个月/当月' type,t1.*,'套餐' line
                  from (
                          ---第一个月/当月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select case when t4.code ='15' then '居家月子' else '医美' end firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                           t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end   
                                union all
                                select hospitalname,  
                                       name patientname,
                                       phone phone,
                                       firstname,
                                       wm_concat(distinct secondname) secondname,
                                       wm_concat(distinct packagename) packagename,
                                       case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                            when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                              else 0 end amount,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                                       to_char(out_date,'yyyy-mm-dd') out_date,
                                       channel1,
                                       channel2
                                 from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                  ,cp.channel1
                                                  ,cp.channel2
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,t2.card_no
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                                     from (
                                                           select f.card_no,f.out_date oper_date
                                                            from fin_ipr_inmaininfo f 
                                                           where f.dept_code='1010'
                                                             and f.in_state&lt;&gt;'N'
                                                             and f.patient_no not like 'B%'
                                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                          )t
                                                     inner join (  
                                                                select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                                  from exp_package ep 
                                                                  left join bd_com_package bp on ep.package_id=bp.package_id
                                                                  left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                 where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                                   and cd.code in ('4')
                                                                   and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                      group by t.card_no,t.oper_date
                                                           ) ep3 on tt.card_no=ep3.card_no
                                      group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                               ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                                   union all  
                                  select HOSPITALNAME, 
                                         PATIENTNAME, 
                                         PHONE, 
                                         FIRSTNAME, 
                                         SECONDNAME, 
                                         PACKAGENAME, 
                                         case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                         CASHCOST, 
                                         to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                                         to_char(t.out_date,'yyyy-mm-dd'), 
                                         CHANNEL1, 
                                         CHANNEL2 
                                  from (
                                           select f.card_no,f.out_date out_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                 inner join (  
                                               select  hospitalname,  
                                                    name patientname, 
                                                    phone phone,
                                                    firstname,
                                                    wm_concat(distinct secondname) secondname,
                                                    wm_concat(distinct packagename) packagename,
                                                    trans amount,
                                                    round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                    oper_date,
                                                    channel1,
                                                    channel2,
                                                    card_no,
                                                    invoice_no
                                             from (       
                                                  select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 广州
                                                         t3.package_name packagename,
                                                          t.invoice_no invoice_no,
                                                          t.real_cost invoice_real,
                                                          t2.real_cost,
                                                         cp.name,
                                                          t2.oper_date oper_date,
                                                          nvl((select sum(a.real_cost)
                                                                 from exp_packagepaymode a
                                                                where a.invoice_no = t.invoice_no
                                                                      and a.trans_type = t.trans_type 
                                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                          ,case when t3.package_name like '%自选包%' then  0 
                                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                          ,t7.package_name secondname
                                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                          ,cp.channel1
                                                          ,cp.channel2
                                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                          ,t2.card_no
                                                          ,decode(t2.trans_type,1,1,2,-1) trans
                                                     from exp_packageinvoice t
                                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                    where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                          and t4.code!='21'
                                                          and t4.code in ('2','7','8','9','10','22','23','24')
                                                          and t.trans_type = t2.trans_type
                                               )tt 
                                              group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date )t1
                 union all
                select  '第二个月' type,t2.*，'套餐' line
                  from (
                        ---第二个月
                        select hospitalname,  
                               name patientname,
                               phone phone,
                               firstname,
                               wm_concat(distinct secondname) secondname,
                               wm_concat(distinct packagename) packagename,
                               case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                    when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                      else 0 end amount,
                               round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd') oper_date,
                               to_char(out_date,'yyyy-mm-dd') out_date,
                               channel1,
                               channel2
                             -- ,invoice_no invoice_no
                         
                          from (        --妇科、生活美容、LPG、中医科、其他  
                                  select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                         t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                         cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,case when t3.package_name like '%自选包%' then  0 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                          ,t7.package_name secondname
                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                          and t4.code!='21'
                                          and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                          and t.trans_type = t2.trans_type
                                  union all---医美 
                                  select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                          t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                          cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,decode(t2.trans_type,1,1,2,-1) amount
                                          ,t7.package_name secondname
                                          ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                          and t4.code!='21'
                                          and t4.code in ('25'，'6','15')
                                          and t.trans_type = t2.trans_type
                                 )tt 
                        inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                        ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                         and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,type,t.oper_date
                                           ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                              group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                       ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                        union all
                       select hospitalname, 
                              name patientname,
                              phone phone,
                              firstname,
                              wm_concat(distinct secondname) secondname,
                              wm_concat(distinct packagename) packagename,
                             case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                  when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                    else 0 end amount,
                             round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd'),
                             to_char(out_date,'yyyy-mm-dd'),
                             channel1,
                             channel2
                        from (  
                            select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                      t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                      cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,-1) amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                             and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                             then replace(t4.name,'套餐','')
                                            else replace(t4.name,'套餐','')||'加收' end  firstname
                                      ,cp.channel1
                                      ,cp.channel2
                                       ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                      ,t8.invoice_no i
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join (select ep.* 
                                             from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                            where epd.clinic_code=ep.clinic_code 
                                              and epd.trans_type=ep.trans_type
                                              and ep.package_id=bp.package_id 
                                              and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                      and t4.code!='21'
                                      and t4.code in ('1','3')
                          )t  
                        inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      ,replace(cd.name,'套餐','')  type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                  and cd.code in ('1','3')
                                                  and ep.pay_flag=1 
                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                  and  bp.package_name not like '%自选包%' 
                                                  and bp.package_name not like '%无痛%' 
                                                  and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                group by t.card_no,type,t.oper_date
                                       ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                          group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                           ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                    union all
                    select hospitalname,  
                           name patientname,
                           phone phone,
                           firstname,
                           wm_concat(distinct secondname) secondname,
                           wm_concat(distinct packagename) packagename,
                           case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                  else 0 end amount,
                           round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                           to_char(out_date,'yyyy-mm-dd') out_date,
                           channel1,
                           channel2
                     from (       
                           select   replace(t4.name,'套餐','')  firstname, ---产检 
                                     t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                     cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,'-1') amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,cp.channel1
                                      ,cp.channel2
                                      ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                      and t4.code!='21'
                                      and t4.code in ('4')
                                      and t.trans_type = t2.trans_type
                              )tt 
                          inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                         from (
                                               select f.card_no,f.out_date oper_date
                                                from fin_ipr_inmaininfo f 
                                               where f.dept_code='1010'
                                                 and f.in_state&lt;&gt;'N'
                                                 and f.patient_no not like 'B%'
                                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                              )t
                                         inner join (  
                                                    select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      from exp_package ep 
                                                      left join bd_com_package bp on ep.package_id=bp.package_id
                                                      left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                       and cd.code in ('4')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,t.oper_date
                                               ) ep3 on tt.card_no=ep3.card_no
                          group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                   ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                       union all 
                      select HOSPITALNAME, 
                             PATIENTNAME, 
                             PHONE, 
                             FIRSTNAME, 
                             SECONDNAME, 
                             PACKAGENAME, 
                             case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                             CASHCOST, 
                             to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                             to_char(t.out_date,'yyyy-mm-dd'), 
                             CHANNEL1, 
                             CHANNEL2 
                      from (
                               select f.card_no,f.out_date out_date
                                from fin_ipr_inmaininfo f 
                               where f.dept_code='1010'
                                 and f.in_state&lt;&gt;'N'
                                 and f.patient_no not like 'B%'
                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                              )t
                     inner join (  
                                   select  hospitalname,   
                                        name patientname,
                                        phone phone,
                                        firstname,
                                        wm_concat(distinct secondname) secondname,
                                        wm_concat(distinct packagename) packagename,
                                        trans amount,
                                        round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                        oper_date,
                                        channel1,
                                        channel2,
                                        card_no,
                                        invoice_no
                                 from (       
                                      select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                             t3.package_name packagename,
                                              t.invoice_no invoice_no,
                                              t.real_cost invoice_real,
                                              t2.real_cost,
                                             cp.name,
                                              t2.oper_date oper_date,
                                              nvl((select sum(a.real_cost)
                                                     from exp_packagepaymode a
                                                    where a.invoice_no = t.invoice_no
                                                          and a.trans_type = t.trans_type 
                                                          and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                              ,case when t3.package_name like '%自选包%' then  0 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                              ,t7.package_name secondname
                                              ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                              , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                              ,cp.channel1
                                              ,cp.channel2
                                              ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                              ,t2.card_no
                                              ,decode(t2.trans_type,1,1,2,-1) trans
                                         from exp_packageinvoice t
                                         left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                         left join bd_com_package t3 on t2.package_id = t3.package_id
                                         left join bd_com_package t7 on t3.parent_code=t7.package_id
                                         left join com_patientinfo cp on t2.card_no=cp.card_no
                                         left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                        where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                              and t4.code!='21'
                                              and t4.code in ('2','7','8','9','10','22','23','24')
                                              and t.trans_type = t2.trans_type
                                   )tt 
                                  group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t2 
                 union all
                select  '第三个月' type,t3.*,'套餐' line
                  from (
                    ---第三个月
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                  when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                           -- ,invoice_no invoice_no
                       
                        from (        --妇科、生活美容、LPG、中医科、其他  
                                select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,case when t3.package_name like '%自选包%' then  0 
                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                              when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                        and t4.code!='21'
                                        and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                        and t.trans_type = t2.trans_type
                                union all---医美 
                                select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                        , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                        and t4.code!='21'
                                        and t4.code in ('25'，'6','15')
                                        and t.trans_type = t2.trans_type
                               )tt 
                      inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                      ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                 where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                       and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                        group by t.card_no,type,t.oper_date
                                         ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                     ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                      union all
                     select hospitalname, 
                            name patientname,
                            phone phone,
                            firstname,
                            wm_concat(distinct secondname) secondname,
                            wm_concat(distinct packagename) packagename,
                           case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                  else 0 end amount,
                           round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(oper_date,'yyyy-mm-dd'),
                           to_char(out_date,'yyyy-mm-dd'),
                           channel1,
                           channel2
                      from (  
                          select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                    t3.package_name packagename,
                                    t.invoice_no invoice_no,
                                    t.real_cost invoice_real,
                                    t2.real_cost,
                                    cp.name,
                                    t2.oper_date oper_date,
                                    nvl((select sum(a.real_cost)
                                           from exp_packagepaymode a
                                          where a.invoice_no = t.invoice_no
                                                and a.trans_type = t.trans_type 
                                                and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                    ,decode(t2.trans_type,1,1,2,-1) amount
                                    ,t7.package_name secondname
                                    ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                    ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                           and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                           then replace(t4.name,'套餐','')
                                          else replace(t4.name,'套餐','')||'加收' end  firstname
                                    ,cp.channel1
                                    ,cp.channel2
                                     ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                    ,t2.card_no
                                    ,t8.invoice_no i
                               from exp_packageinvoice t
                               left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                               left join (select ep.* 
                                           from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                          where epd.clinic_code=ep.clinic_code 
                                            and epd.trans_type=ep.trans_type
                                            and ep.package_id=bp.package_id 
                                            and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                               left join bd_com_package t3 on t2.package_id = t3.package_id
                               left join bd_com_package t7 on t3.parent_code=t7.package_id
                               left join com_patientinfo cp on t2.card_no=cp.card_no
                               left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                              where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                    and t4.code!='21'
                                    and t4.code in ('1','3')
                        )t  
                      inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                 from (
                                       select f.card_no,f.out_date oper_date
                                        from fin_ipr_inmaininfo f 
                                       where f.dept_code='1010'
                                         and f.in_state&lt;&gt;'N'
                                         and f.patient_no not like 'B%'
                                         and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                      )t
                                 inner join (  
                                             select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                    ,replace(cd.name,'套餐','')  type
                                               from exp_package ep 
                                               left join bd_com_package bp on ep.package_id=bp.package_id
                                               left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                              where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                and cd.code in ('1','3')
                                                and ep.pay_flag=1 
                                                and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                and  bp.package_name not like '%自选包%' 
                                                and bp.package_name not like '%无痛%' 
                                                and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                              group by t.card_no,type,t.oper_date
                                     ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                        group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                         ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                  union all
                  select hospitalname,  
                         name patientname,
                         phone phone,
                         firstname,
                         wm_concat(distinct secondname) secondname,
                         wm_concat(distinct packagename) packagename,
                         case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                              when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                else 0 end amount,
                         round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                         to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                         to_char(out_date,'yyyy-mm-dd') out_date,
                         channel1,
                         channel2
                   from (       
                         select   replace(t4.name,'套餐','')  firstname, ---产检 
                                   t3.package_name packagename,
                                    t.invoice_no invoice_no,
                                    t.real_cost invoice_real,
                                    t2.real_cost,
                                   cp.name,
                                    t2.oper_date oper_date,
                                    nvl((select sum(a.real_cost)
                                           from exp_packagepaymode a
                                          where a.invoice_no = t.invoice_no
                                                and a.trans_type = t.trans_type 
                                                and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                    ,decode(t2.trans_type,1,1,2,'-1') amount
                                    ,t7.package_name secondname
                                    ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                    ,cp.channel1
                                    ,cp.channel2
                                    ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                    ,t2.card_no
                               from exp_packageinvoice t
                               left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                               left join bd_com_package t3 on t2.package_id = t3.package_id
                               left join bd_com_package t7 on t3.parent_code=t7.package_id
                               left join com_patientinfo cp on t2.card_no=cp.card_no
                               left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                              where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                    and t4.code!='21'
                                    and t4.code in ('4')
                                    and t.trans_type = t2.trans_type
                            )tt 
                        inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                    from exp_package ep 
                                                    left join bd_com_package bp on ep.package_id=bp.package_id
                                                    left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                     and cd.code in ('4')
                                                     and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                        group by t.card_no,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no
                        group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                 ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                     union all 
                    select HOSPITALNAME, 
                           PATIENTNAME, 
                           PHONE, 
                           FIRSTNAME, 
                           SECONDNAME, 
                           PACKAGENAME, 
                           case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                           CASHCOST, 
                           to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                           to_char(t.out_date,'yyyy-mm-dd'), 
                           CHANNEL1, 
                           CHANNEL2 
                    from (
                             select f.card_no,f.out_date out_date
                              from fin_ipr_inmaininfo f 
                             where f.dept_code='1010'
                               and f.in_state&lt;&gt;'N'
                               and f.patient_no not like 'B%'
                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                            )t
                   inner join (  
                                 select  hospitalname,   
                                      name patientname,
                                      phone phone,
                                      firstname,
                                      wm_concat(distinct secondname) secondname,
                                      wm_concat(distinct packagename) packagename,
                                      trans amount,
                                      round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                      oper_date,
                                      channel1,
                                      channel2,
                                      card_no,
                                      invoice_no
                               from (       
                                    select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 广州
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                            ,decode(t2.trans_type,1,1,2,-1) trans
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                            and t4.code!='21'
                                            and t4.code in ('2','7','8','9','10','22','23','24')
                                            and t.trans_type = t2.trans_type
                                 )tt 
                                group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t3                                                                                            
                 union all
                select  '第四个月' type,t4.*,'套餐' line 
                  from (
                        ---第四个月
                        select hospitalname,  
                               name patientname,
                               phone phone,
                               firstname,
                               wm_concat(distinct secondname) secondname,
                               wm_concat(distinct packagename) packagename,
                               case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                    when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                      else 0 end amount,
                               round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd') oper_date,
                               to_char(out_date,'yyyy-mm-dd') out_date,
                               channel1,
                               channel2
                             -- ,invoice_no invoice_no
                         
                          from (        --妇科、生活美容、LPG、中医科、其他  
                                  select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                         t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                         cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,case when t3.package_name like '%自选包%' then  0 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                          ,t7.package_name secondname
                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                          and t4.code!='21'
                                          and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                          and t.trans_type = t2.trans_type
                                  union all---医美 
                                  select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                          t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                          cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,decode(t2.trans_type,1,1,2,-1) amount
                                          ,t7.package_name secondname
                                          ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                          and t4.code!='21'
                                          and t4.code in ('25'，'6','15')
                                          and t.trans_type = t2.trans_type
                                 )tt 
                        inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                        ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                         and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,type,t.oper_date
                                           ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                              group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                       ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                        union all
                       select hospitalname, 
                              name patientname,
                              phone phone,
                              firstname,
                              wm_concat(distinct secondname) secondname,
                              wm_concat(distinct packagename) packagename,
                             case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                  when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                    else 0 end amount,
                             round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd'),
                             to_char(out_date,'yyyy-mm-dd'),
                             channel1,
                             channel2
                        from (  
                            select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                      t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                      cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,-1) amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                             and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                             then replace(t4.name,'套餐','')
                                            else replace(t4.name,'套餐','')||'加收' end  firstname
                                      ,cp.channel1
                                      ,cp.channel2
                                       ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                      ,t8.invoice_no i
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join (select ep.* 
                                             from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                            where epd.clinic_code=ep.clinic_code 
                                              and epd.trans_type=ep.trans_type
                                              and ep.package_id=bp.package_id 
                                              and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                      and t4.code!='21'
                                      and t4.code in ('1','3')
                          )t  
                        inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      ,replace(cd.name,'套餐','')  type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                  and cd.code in ('1','3')
                                                  and ep.pay_flag=1 
                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                  and  bp.package_name not like '%自选包%' 
                                                  and bp.package_name not like '%无痛%' 
                                                  and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                group by t.card_no,type,t.oper_date
                                       ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                          group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                           ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                    union all
                    select hospitalname,  
                           name patientname,
                           phone phone,
                           firstname,
                           wm_concat(distinct secondname) secondname,
                           wm_concat(distinct packagename) packagename,
                           case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                  else 0 end amount,
                           round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                           to_char(out_date,'yyyy-mm-dd') out_date,
                           channel1,
                           channel2
                     from (       
                           select   replace(t4.name,'套餐','')  firstname, ---产检 
                                     t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                     cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,'-1') amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,cp.channel1
                                      ,cp.channel2
                                      ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                      and t4.code!='21'
                                      and t4.code in ('4')
                                      and t.trans_type = t2.trans_type
                              )tt 
                          inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                         from (
                                               select f.card_no,f.out_date oper_date
                                                from fin_ipr_inmaininfo f 
                                               where f.dept_code='1010'
                                                 and f.in_state&lt;&gt;'N'
                                                 and f.patient_no not like 'B%'
                                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                              )t
                                         inner join (  
                                                    select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      from exp_package ep 
                                                      left join bd_com_package bp on ep.package_id=bp.package_id
                                                      left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                       and cd.code in ('4')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,t.oper_date
                                               ) ep3 on tt.card_no=ep3.card_no
                          group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                   ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                       union all 
                      select HOSPITALNAME, 
                             PATIENTNAME, 
                             PHONE, 
                             FIRSTNAME, 
                             SECONDNAME, 
                             PACKAGENAME, 
                             case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                             CASHCOST, 
                             to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                             to_char(t.out_date,'yyyy-mm-dd'), 
                             CHANNEL1, 
                             CHANNEL2 
                      from (
                               select f.card_no,f.out_date out_date
                                from fin_ipr_inmaininfo f 
                               where f.dept_code='1010'
                                 and f.in_state&lt;&gt;'N'
                                 and f.patient_no not like 'B%'
                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                              )t
                     inner join (  
                                   select  hospitalname,   
                                        name patientname,
                                        phone phone,
                                        firstname,
                                        wm_concat(distinct secondname) secondname,
                                        wm_concat(distinct packagename) packagename,
                                        trans amount,
                                        round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                        oper_date,
                                        channel1,
                                        channel2,
                                        card_no,
                                        invoice_no
                                 from (       
                                      select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                             t3.package_name packagename,
                                              t.invoice_no invoice_no,
                                              t.real_cost invoice_real,
                                              t2.real_cost,
                                             cp.name,
                                              t2.oper_date oper_date,
                                              nvl((select sum(a.real_cost)
                                                     from exp_packagepaymode a
                                                    where a.invoice_no = t.invoice_no
                                                          and a.trans_type = t.trans_type 
                                                          and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                              ,case when t3.package_name like '%自选包%' then  0 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                              ,t7.package_name secondname
                                              ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                              , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                              ,cp.channel1
                                              ,cp.channel2
                                              ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                              ,t2.card_no
                                              ,decode(t2.trans_type,1,1,2,-1) trans
                                         from exp_packageinvoice t
                                         left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                         left join bd_com_package t3 on t2.package_id = t3.package_id
                                         left join bd_com_package t7 on t3.parent_code=t7.package_id
                                         left join com_patientinfo cp on t2.card_no=cp.card_no
                                         left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                        where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                              and t4.code!='21'
                                              and t4.code in ('2','7','8','9','10','22','23','24')
                                              and t.trans_type = t2.trans_type
                                   )tt 
                                  group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t4
                  union all
                 select  '第五个月' type,t5.*，'套餐' line
                   from (
                         ---第五个月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                            t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                            cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                      union all
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                  when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                       from (       
                             select   replace(t4.name,'套餐','')  firstname, ---产检 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,'-1') amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                        and t4.code!='21'
                                        and t4.code in ('4')
                                        and t.trans_type = t2.trans_type
                                )tt 
                            inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                           from (
                                                 select f.card_no,f.out_date oper_date
                                                  from fin_ipr_inmaininfo f 
                                                 where f.dept_code='1010'
                                                   and f.in_state&lt;&gt;'N'
                                                   and f.patient_no not like 'B%'
                                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                )t
                                           inner join (  
                                                      select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        from exp_package ep 
                                                        left join bd_com_package bp on ep.package_id=bp.package_id
                                                        left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                       where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                         and cd.code in ('4')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,t.oper_date
                                                 ) ep3 on tt.card_no=ep3.card_no
                            group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                     ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                         union all 
                        select HOSPITALNAME, 
                               PATIENTNAME, 
                               PHONE, 
                               FIRSTNAME, 
                               SECONDNAME, 
                               PACKAGENAME, 
                               case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                               CASHCOST, 
                               to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                               to_char(t.out_date,'yyyy-mm-dd'), 
                               CHANNEL1, 
                               CHANNEL2 
                        from (
                                 select f.card_no,f.out_date out_date
                                  from fin_ipr_inmaininfo f 
                                 where f.dept_code='1010'
                                   and f.in_state&lt;&gt;'N'
                                   and f.patient_no not like 'B%'
                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                )t
                       inner join (  
                                     select  hospitalname,   
                                          name patientname,
                                          phone phone,
                                          firstname,
                                          wm_concat(distinct secondname) secondname,
                                          wm_concat(distinct packagename) packagename,
                                          trans amount,
                                          round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                          oper_date,
                                          channel1,
                                          channel2,
                                          card_no,
                                          invoice_no
                                   from (       
                                        select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                               t3.package_name packagename,
                                                t.invoice_no invoice_no,
                                                t.real_cost invoice_real,
                                                t2.real_cost,
                                               cp.name,
                                                t2.oper_date oper_date,
                                                nvl((select sum(a.real_cost)
                                                       from exp_packagepaymode a
                                                      where a.invoice_no = t.invoice_no
                                                            and a.trans_type = t.trans_type 
                                                            and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                ,case when t3.package_name like '%自选包%' then  0 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                ,t7.package_name secondname
                                                ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                ,cp.channel1
                                                ,cp.channel2
                                                ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                ,t2.card_no
                                                ,decode(t2.trans_type,1,1,2,-1) trans
                                           from exp_packageinvoice t
                                           left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                           left join bd_com_package t3 on t2.package_id = t3.package_id
                                           left join bd_com_package t7 on t3.parent_code=t7.package_id
                                           left join com_patientinfo cp on t2.card_no=cp.card_no
                                           left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                          where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                                and t4.code!='21'
                                                and t4.code in ('2','7','8','9','10','22','23','24')
                                                and t.trans_type = t2.trans_type
                                     )tt 
                                    group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t5                                               
                  union all
                 select  '第六个月' type,t6.*,'套餐' line
                   from (
                           ---第六个月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                            t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                            cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                      union all
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                  when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                       from (       
                             select   replace(t4.name,'套餐','')  firstname, ---产检 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,'-1') amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                        and t4.code!='21'
                                        and t4.code in ('4')
                                        and t.trans_type = t2.trans_type
                                )tt 
                            inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                           from (
                                                 select f.card_no,f.out_date oper_date
                                                  from fin_ipr_inmaininfo f 
                                                 where f.dept_code='1010'
                                                   and f.in_state&lt;&gt;'N'
                                                   and f.patient_no not like 'B%'
                                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                )t
                                           inner join (  
                                                      select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        from exp_package ep 
                                                        left join bd_com_package bp on ep.package_id=bp.package_id
                                                        left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                       where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                         and cd.code in ('4')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,t.oper_date
                                                 ) ep3 on tt.card_no=ep3.card_no
                            group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                     ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                         union all 
                        select HOSPITALNAME, 
                               PATIENTNAME, 
                               PHONE, 
                               FIRSTNAME, 
                               SECONDNAME, 
                               PACKAGENAME, 
                               case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                               CASHCOST, 
                               to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                               to_char(t.out_date,'yyyy-mm-dd'), 
                               CHANNEL1, 
                               CHANNEL2 
                        from (
                                 select f.card_no,f.out_date out_date
                                  from fin_ipr_inmaininfo f 
                                 where f.dept_code='1010'
                                   and f.in_state&lt;&gt;'N'
                                   and f.patient_no not like 'B%'
                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                )t
                       inner join (  
                                     select  hospitalname,   
                                          name patientname,
                                          phone phone,
                                          firstname,
                                          wm_concat(distinct secondname) secondname,
                                          wm_concat(distinct packagename) packagename,
                                          trans amount,
                                          round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                          oper_date,
                                          channel1,
                                          channel2,
                                          card_no,
                                          invoice_no
                                   from (       
                                        select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                               t3.package_name packagename,
                                                t.invoice_no invoice_no,
                                                t.real_cost invoice_real,
                                                t2.real_cost,
                                               cp.name,
                                                t2.oper_date oper_date,
                                                nvl((select sum(a.real_cost)
                                                       from exp_packagepaymode a
                                                      where a.invoice_no = t.invoice_no
                                                            and a.trans_type = t.trans_type 
                                                            and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                ,case when t3.package_name like '%自选包%' then  0 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                ,t7.package_name secondname
                                                ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                ,cp.channel1
                                                ,cp.channel2
                                                ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                ,t2.card_no
                                                ,decode(t2.trans_type,1,1,2,-1) trans
                                           from exp_packageinvoice t
                                           left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                           left join bd_com_package t3 on t2.package_id = t3.package_id
                                           left join bd_com_package t7 on t3.parent_code=t7.package_id
                                           left join com_patientinfo cp on t2.card_no=cp.card_no
                                           left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                          where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                                and t4.code!='21'
                                                and t4.code in ('2','7','8','9','10','22','23','24')
                                                and t.trans_type = t2.trans_type
                                     )tt 
                                    group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t6
                  ) t9 on t7.line=t9.line and t7.name=t9.firstname
                  group by t7.name,t8.amount
               union all
               select '合计',
       t10.amount ,
       sum(t10.第一个月套餐购买人) 第一个月套餐购买人次,
       to_char(round(sum(t10.第一个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第一个月套餐购买率,
       sum(t10.第二个月套餐购买人) 第二个月套餐购买人次,
       to_char(round(sum(t10.第二个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第二个月套餐购买率,
       sum(t10.第三个月套餐购买人) 第三个月套餐购买人次,
       to_char(round(sum(t10.第三个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第三个月套餐购买率,
       sum(t10.第四个月套餐购买人) 第四个月套餐购买人次,
       to_char(round(sum(t10.第四个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第四个月套餐购买率,
       sum(t10.第五个月套餐购买人) 第五个月套餐购买人次,
       to_char(round(sum(t10.第五个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第五个月套餐购买率,
       sum(t10.第六个月套餐购买人) 第六个月套餐购买人次,
       to_char(round(sum(t10.第六个月套餐购买人)/t10.amount*100,2),'fm999990.99999')||'%' 第六个月套餐购买率
  from ( 
    select 
           t9.patientname,t8.amount,
           case when sum(case when t9.type='第一个月/当月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第一个月/当月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第一个月/当月' then t9.amount else 0 end)&lt;0 then -1 end  第一个月套餐购买人，
           case when sum(case when t9.type='第二个月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第二个月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第二个月' then t9.amount else 0 end)&lt;0 then -1 end  第二个月套餐购买人，
           case when sum(case when t9.type='第三个月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第三个月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第三个月' then t9.amount else 0 end)&lt;0 then -1 end  第三个月套餐购买人，
           case when sum(case when t9.type='第四个月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第四个月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第四个月' then t9.amount else 0 end)&lt;0 then -1 end  第四个月套餐购买人，
           case when sum(case when t9.type='第五个月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第五个月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第五个月' then t9.amount else 0 end)&lt;0 then -1 end  第五个月套餐购买人，
           case when sum(case when t9.type='第六个月' then t9.amount else 0 end)&gt;0 then 1 
                when sum(case when t9.type='第六个月' then t9.amount else 0 end)=0 then 0
                when sum(case when t9.type='第六个月' then t9.amount else 0 end)&lt;0 then -1 end  第六个月套餐购买人
          /*sum(case when t9.type='第一个月/当月' then t9.amount else 0 end) 第一个月套餐购买人次,
          to_char(round(sum(case when t9.type='第一个月/当月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第一个月套餐购买率,
          sum(case when t9.type='第二个月' then t9.amount else 0 end) 第二个月套餐购买人次,
          to_char(round(sum(case when t9.type='第二个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第二个月套餐购买率,
          sum(case when t9.type='第三个月' then t9.amount else 0 end) 第三个月套餐购买人次,
          to_char(round(sum(case when t9.type='第三个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第三个月套餐购买率,
          sum(case when t9.type='第四个月' then t9.amount else 0 end) 第四个月套餐购买人次,
          to_char(round(sum(case when t9.type='第四个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第四个月套餐购买率,
          sum(case when t9.type='第五个月' then t9.amount else 0 end) 第五个月套餐购买人次,
          to_char(round(sum(case when t9.type='第五个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第五个月套餐购买率,
          sum(case when t9.type='第六个月' then t9.amount else 0 end) 第六个月套餐购买人次，
          to_char(round(sum(case when t9.type='第六个月' then t9.amount else 0 end)/t8.amount*100,2),'fm999990.99999')||'%' 第六个月套餐购买率*/
      from ( select distinct case when cd.code in ('11','14','5','19') then '妇科' 
                                  when cd.code in ('25'，'6') then '医美'
                                  when cd.code in ('7','8','9','10','22','23','24') then '综'
                                  else replace(cd.name,'套餐','') end name,'套餐' line
               from com_dictionary cd where cd.type='PACKAGETYPE' and cd.name not like '%代收%')t7 
      left join (select '套餐' line,count(f.card_no) amount
                   from fin_ipr_inmaininfo f 
                  where f.dept_code='1010'
                    and f.in_state&lt;&gt;'N'
                    and f.patient_no not like 'B%'
                    and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ) t8 on t7.line=t8.line
            left join (select  '第一个月/当月' type,t1.*,'套餐' line
                  from (
                          ---第一个月/当月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select case when t4.code ='15' then '居家月子' else '医美' end firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                           t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end   
                                union all
                                select hospitalname,  
                                       name patientname,
                                       phone phone,
                                       firstname,
                                       wm_concat(distinct secondname) secondname,
                                       wm_concat(distinct packagename) packagename,
                                       case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                            when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                              else 0 end amount,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                                       to_char(out_date,'yyyy-mm-dd') out_date,
                                       channel1,
                                       channel2
                                 from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                  ,cp.channel1
                                                  ,cp.channel2
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,t2.card_no
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                                     from (
                                                           select f.card_no,f.out_date oper_date
                                                            from fin_ipr_inmaininfo f 
                                                           where f.dept_code='1010'
                                                             and f.in_state&lt;&gt;'N'
                                                             and f.patient_no not like 'B%'
                                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                          )t
                                                     inner join (  
                                                                select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                                  from exp_package ep 
                                                                  left join bd_com_package bp on ep.package_id=bp.package_id
                                                                  left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                 where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                                   and cd.code in ('4')
                                                                   and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                      group by t.card_no,t.oper_date
                                                           ) ep3 on tt.card_no=ep3.card_no
                                      group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                               ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                                   union all  
                                  select HOSPITALNAME, 
                                         PATIENTNAME, 
                                         PHONE, 
                                         FIRSTNAME, 
                                         SECONDNAME, 
                                         PACKAGENAME, 
                                         case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                         CASHCOST, 
                                         to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                                         to_char(t.out_date,'yyyy-mm-dd'), 
                                         CHANNEL1, 
                                         CHANNEL2 
                                  from (
                                           select f.card_no,f.out_date out_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                 inner join (  
                                               select  hospitalname,  
                                                    name patientname, 
                                                    phone phone,
                                                    firstname,
                                                    wm_concat(distinct secondname) secondname,
                                                    wm_concat(distinct packagename) packagename,
                                                    trans amount,
                                                    round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                    oper_date,
                                                    channel1,
                                                    channel2,
                                                    card_no,
                                                    invoice_no
                                             from (       
                                                  select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                                         t3.package_name packagename,
                                                          t.invoice_no invoice_no,
                                                          t.real_cost invoice_real,
                                                          t2.real_cost,
                                                         cp.name,
                                                          t2.oper_date oper_date,
                                                          nvl((select sum(a.real_cost)
                                                                 from exp_packagepaymode a
                                                                where a.invoice_no = t.invoice_no
                                                                      and a.trans_type = t.trans_type 
                                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                          ,case when t3.package_name like '%自选包%' then  0 
                                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                          ,t7.package_name secondname
                                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                          ,cp.channel1
                                                          ,cp.channel2
                                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                          ,t2.card_no
                                                          ,decode(t2.trans_type,1,1,2,-1) trans
                                                     from exp_packageinvoice t
                                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                    where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                          and t4.code!='21'
                                                          and t4.code in ('2','7','8','9','10','22','23','24')
                                                          and t.trans_type = t2.trans_type
                                               )tt 
                                              group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date )t1
                 union all
                select  '第二个月' type,t2.*，'套餐' line
                  from (
                        ---第二个月
                        select hospitalname,  
                               name patientname,
                               phone phone,
                               firstname,
                               wm_concat(distinct secondname) secondname,
                               wm_concat(distinct packagename) packagename,
                               case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                    when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                      else 0 end amount,
                               round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd') oper_date,
                               to_char(out_date,'yyyy-mm-dd') out_date,
                               channel1,
                               channel2
                             -- ,invoice_no invoice_no
                         
                          from (        --妇科、生活美容、LPG、中医科、其他  
                                  select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                         t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                         cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,case when t3.package_name like '%自选包%' then  0 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                          ,t7.package_name secondname
                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                          and t4.code!='21'
                                          and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                          and t.trans_type = t2.trans_type
                                  union all---医美 
                                  select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                          t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                          cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,decode(t2.trans_type,1,1,2,-1) amount
                                          ,t7.package_name secondname
                                          ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                          and t4.code!='21'
                                          and t4.code in ('25'，'6','15')
                                          and t.trans_type = t2.trans_type
                                 )tt 
                        inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                        ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                         and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,type,t.oper_date
                                           ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                              group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                       ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                        union all
                       select hospitalname, 
                              name patientname,
                              phone phone,
                              firstname,
                              wm_concat(distinct secondname) secondname,
                              wm_concat(distinct packagename) packagename,
                             case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                  when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                    else 0 end amount,
                             round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd'),
                             to_char(out_date,'yyyy-mm-dd'),
                             channel1,
                             channel2
                        from (  
                            select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                      t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                      cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,-1) amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                             and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                             then replace(t4.name,'套餐','')
                                            else replace(t4.name,'套餐','')||'加收' end  firstname
                                      ,cp.channel1
                                      ,cp.channel2
                                       ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                      ,t8.invoice_no i
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join (select ep.* 
                                             from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                            where epd.clinic_code=ep.clinic_code 
                                              and epd.trans_type=ep.trans_type
                                              and ep.package_id=bp.package_id 
                                              and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                      and t4.code!='21'
                                      and t4.code in ('1','3')
                          )t  
                        inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      ,replace(cd.name,'套餐','')  type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                  and cd.code in ('1','3')
                                                  and ep.pay_flag=1 
                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                  and  bp.package_name not like '%自选包%' 
                                                  and bp.package_name not like '%无痛%' 
                                                  and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                group by t.card_no,type,t.oper_date
                                       ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                          group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                           ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                    union all
                    select hospitalname,  
                           name patientname,
                           phone phone,
                           firstname,
                           wm_concat(distinct secondname) secondname,
                           wm_concat(distinct packagename) packagename,
                           case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                  else 0 end amount,
                           round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                           to_char(out_date,'yyyy-mm-dd') out_date,
                           channel1,
                           channel2
                     from (       
                           select   replace(t4.name,'套餐','')  firstname, ---产检 
                                     t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                     cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,'-1') amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,cp.channel1
                                      ,cp.channel2
                                      ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                      and t4.code!='21'
                                      and t4.code in ('4')
                                      and t.trans_type = t2.trans_type
                              )tt 
                          inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                         from (
                                               select f.card_no,f.out_date oper_date
                                                from fin_ipr_inmaininfo f 
                                               where f.dept_code='1010'
                                                 and f.in_state&lt;&gt;'N'
                                                 and f.patient_no not like 'B%'
                                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                              )t
                                         inner join (  
                                                    select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      from exp_package ep 
                                                      left join bd_com_package bp on ep.package_id=bp.package_id
                                                      left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1)
                                                       and cd.code in ('4')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,t.oper_date
                                               ) ep3 on tt.card_no=ep3.card_no
                          group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                   ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                       union all 
                      select HOSPITALNAME, 
                             PATIENTNAME, 
                             PHONE, 
                             FIRSTNAME, 
                             SECONDNAME, 
                             PACKAGENAME, 
                             case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                             CASHCOST, 
                             to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                             to_char(t.out_date,'yyyy-mm-dd'), 
                             CHANNEL1, 
                             CHANNEL2 
                      from (
                               select f.card_no,f.out_date out_date
                                from fin_ipr_inmaininfo f 
                               where f.dept_code='1010'
                                 and f.in_state&lt;&gt;'N'
                                 and f.patient_no not like 'B%'
                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                              )t
                     inner join (  
                                   select  hospitalname,   
                                        name patientname,
                                        phone phone,
                                        firstname,
                                        wm_concat(distinct secondname) secondname,
                                        wm_concat(distinct packagename) packagename,
                                        trans amount,
                                        round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                        oper_date,
                                        channel1,
                                        channel2,
                                        card_no,
                                        invoice_no
                                 from (       
                                      select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                             t3.package_name packagename,
                                              t.invoice_no invoice_no,
                                              t.real_cost invoice_real,
                                              t2.real_cost,
                                             cp.name,
                                              t2.oper_date oper_date,
                                              nvl((select sum(a.real_cost)
                                                     from exp_packagepaymode a
                                                    where a.invoice_no = t.invoice_no
                                                          and a.trans_type = t.trans_type 
                                                          and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                              ,case when t3.package_name like '%自选包%' then  0 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                              ,t7.package_name secondname
                                              ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                              , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                              ,cp.channel1
                                              ,cp.channel2
                                              ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                              ,t2.card_no
                                              ,decode(t2.trans_type,1,1,2,-1) trans
                                         from exp_packageinvoice t
                                         left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                         left join bd_com_package t3 on t2.package_id = t3.package_id
                                         left join bd_com_package t7 on t3.parent_code=t7.package_id
                                         left join com_patientinfo cp on t2.card_no=cp.card_no
                                         left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                        where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,1) 
                                              and t4.code!='21'
                                              and t4.code in ('2','7','8','9','10','22','23','24')
                                              and t.trans_type = t2.trans_type
                                   )tt 
                                  group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t2 
                 union all
                select  '第三个月' type,t3.*,'套餐' line
                  from (
                    ---第三个月
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                  when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                           -- ,invoice_no invoice_no
                       
                        from (        --妇科、生活美容、LPG、中医科、其他  
                                select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,case when t3.package_name like '%自选包%' then  0 
                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                              when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                        and t4.code!='21'
                                        and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                        and t.trans_type = t2.trans_type
                                union all---医美 
                                select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                        , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                        and t4.code!='21'
                                        and t4.code in ('25'，'6','15')
                                        and t.trans_type = t2.trans_type
                               )tt 
                      inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                      ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                 where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                       and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                        group by t.card_no,type,t.oper_date
                                         ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                     ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                      union all
                     select hospitalname, 
                            name patientname,
                            phone phone,
                            firstname,
                            wm_concat(distinct secondname) secondname,
                            wm_concat(distinct packagename) packagename,
                           case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                  else 0 end amount,
                           round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(oper_date,'yyyy-mm-dd'),
                           to_char(out_date,'yyyy-mm-dd'),
                           channel1,
                           channel2
                      from (  
                          select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                    t3.package_name packagename,
                                    t.invoice_no invoice_no,
                                    t.real_cost invoice_real,
                                    t2.real_cost,
                                    cp.name,
                                    t2.oper_date oper_date,
                                    nvl((select sum(a.real_cost)
                                           from exp_packagepaymode a
                                          where a.invoice_no = t.invoice_no
                                                and a.trans_type = t.trans_type 
                                                and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                    ,decode(t2.trans_type,1,1,2,-1) amount
                                    ,t7.package_name secondname
                                    ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                    ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                           and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                           then replace(t4.name,'套餐','')
                                          else replace(t4.name,'套餐','')||'加收' end  firstname
                                    ,cp.channel1
                                    ,cp.channel2
                                     ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                    ,t2.card_no
                                    ,t8.invoice_no i
                               from exp_packageinvoice t
                               left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                               left join (select ep.* 
                                           from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                          where epd.clinic_code=ep.clinic_code 
                                            and epd.trans_type=ep.trans_type
                                            and ep.package_id=bp.package_id 
                                            and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                               left join bd_com_package t3 on t2.package_id = t3.package_id
                               left join bd_com_package t7 on t3.parent_code=t7.package_id
                               left join com_patientinfo cp on t2.card_no=cp.card_no
                               left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                              where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                    and t4.code!='21'
                                    and t4.code in ('1','3')
                        )t  
                      inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                 from (
                                       select f.card_no,f.out_date oper_date
                                        from fin_ipr_inmaininfo f 
                                       where f.dept_code='1010'
                                         and f.in_state&lt;&gt;'N'
                                         and f.patient_no not like 'B%'
                                         and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                      )t
                                 inner join (  
                                             select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                    ,replace(cd.name,'套餐','')  type
                                               from exp_package ep 
                                               left join bd_com_package bp on ep.package_id=bp.package_id
                                               left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                              where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                and cd.code in ('1','3')
                                                and ep.pay_flag=1 
                                                and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                and  bp.package_name not like '%自选包%' 
                                                and bp.package_name not like '%无痛%' 
                                                and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                              group by t.card_no,type,t.oper_date
                                     ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                        group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                         ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                  union all
                  select hospitalname,  
                         name patientname,
                         phone phone,
                         firstname,
                         wm_concat(distinct secondname) secondname,
                         wm_concat(distinct packagename) packagename,
                         case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                              when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                else 0 end amount,
                         round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                         to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                         to_char(out_date,'yyyy-mm-dd') out_date,
                         channel1,
                         channel2
                   from (       
                         select   replace(t4.name,'套餐','')  firstname, ---产检 
                                   t3.package_name packagename,
                                    t.invoice_no invoice_no,
                                    t.real_cost invoice_real,
                                    t2.real_cost,
                                   cp.name,
                                    t2.oper_date oper_date,
                                    nvl((select sum(a.real_cost)
                                           from exp_packagepaymode a
                                          where a.invoice_no = t.invoice_no
                                                and a.trans_type = t.trans_type 
                                                and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                    ,decode(t2.trans_type,1,1,2,'-1') amount
                                    ,t7.package_name secondname
                                    ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                    ,cp.channel1
                                    ,cp.channel2
                                    ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                    ,t2.card_no
                               from exp_packageinvoice t
                               left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                               left join bd_com_package t3 on t2.package_id = t3.package_id
                               left join bd_com_package t7 on t3.parent_code=t7.package_id
                               left join com_patientinfo cp on t2.card_no=cp.card_no
                               left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                              where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                    and t4.code!='21'
                                    and t4.code in ('4')
                                    and t.trans_type = t2.trans_type
                            )tt 
                        inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                    from exp_package ep 
                                                    left join bd_com_package bp on ep.package_id=bp.package_id
                                                    left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2) 
                                                     and cd.code in ('4')
                                                     and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                        group by t.card_no,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no
                        group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                 ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                     union all 
                    select HOSPITALNAME, 
                           PATIENTNAME, 
                           PHONE, 
                           FIRSTNAME, 
                           SECONDNAME, 
                           PACKAGENAME, 
                           case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                           CASHCOST, 
                           to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                           to_char(t.out_date,'yyyy-mm-dd'), 
                           CHANNEL1, 
                           CHANNEL2 
                    from (
                             select f.card_no,f.out_date out_date
                              from fin_ipr_inmaininfo f 
                             where f.dept_code='1010'
                               and f.in_state&lt;&gt;'N'
                               and f.patient_no not like 'B%'
                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                            )t
                   inner join (  
                                 select  hospitalname,   
                                      name patientname,
                                      phone phone,
                                      firstname,
                                      wm_concat(distinct secondname) secondname,
                                      wm_concat(distinct packagename) packagename,
                                      trans amount,
                                      round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                      oper_date,
                                      channel1,
                                      channel2,
                                      card_no,
                                      invoice_no
                               from (       
                                    select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                            ,decode(t2.trans_type,1,1,2,-1) trans
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,2)  
                                            and t4.code!='21'
                                            and t4.code in ('2','7','8','9','10','22','23','24')
                                            and t.trans_type = t2.trans_type
                                 )tt 
                                group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t3                                                                                            
                 union all
                select  '第四个月' type,t4.*,'套餐' line 
                  from (
                        ---第四个月
                        select hospitalname,  
                               name patientname,
                               phone phone,
                               firstname,
                               wm_concat(distinct secondname) secondname,
                               wm_concat(distinct packagename) packagename,
                               case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                    when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                      else 0 end amount,
                               round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd') oper_date,
                               to_char(out_date,'yyyy-mm-dd') out_date,
                               channel1,
                               channel2
                             -- ,invoice_no invoice_no
                         
                          from (        --妇科、生活美容、LPG、中医科、其他  
                                  select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                         t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                         cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,case when t3.package_name like '%自选包%' then  0 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                          ,t7.package_name secondname
                                          ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                          and t4.code!='21'
                                          and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                          and t.trans_type = t2.trans_type
                                  union all---医美 
                                  select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                          t3.package_name packagename,
                                          t.invoice_no invoice_no,
                                          t.real_cost invoice_real,
                                          t2.real_cost,
                                          cp.name,
                                          t2.oper_date oper_date,
                                          nvl((select sum(a.real_cost)
                                                 from exp_packagepaymode a
                                                where a.invoice_no = t.invoice_no
                                                      and a.trans_type = t.trans_type 
                                                      and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                          ,decode(t2.trans_type,1,1,2,-1) amount
                                          ,t7.package_name secondname
                                          ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                          , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                          ,cp.channel1
                                          ,cp.channel2
                                          ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                          ,t2.card_no
                                     from exp_packageinvoice t
                                     left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                     left join bd_com_package t3 on t2.package_id = t3.package_id
                                     left join bd_com_package t7 on t3.parent_code=t7.package_id
                                     left join com_patientinfo cp on t2.card_no=cp.card_no
                                     left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                    where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                          and t4.code!='21'
                                          and t4.code in ('25'，'6','15')
                                          and t.trans_type = t2.trans_type
                                 )tt 
                        inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                        ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                   where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                         and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,type,t.oper_date
                                           ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                              group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                       ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                        union all
                       select hospitalname, 
                              name patientname,
                              phone phone,
                              firstname,
                              wm_concat(distinct secondname) secondname,
                              wm_concat(distinct packagename) packagename,
                             case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                  when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                    else 0 end amount,
                             round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(oper_date,'yyyy-mm-dd'),
                             to_char(out_date,'yyyy-mm-dd'),
                             channel1,
                             channel2
                        from (  
                            select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                      t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                      cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,-1) amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                             and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                             then replace(t4.name,'套餐','')
                                            else replace(t4.name,'套餐','')||'加收' end  firstname
                                      ,cp.channel1
                                      ,cp.channel2
                                       ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                      ,t8.invoice_no i
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join (select ep.* 
                                             from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                            where epd.clinic_code=ep.clinic_code 
                                              and epd.trans_type=ep.trans_type
                                              and ep.package_id=bp.package_id 
                                              and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                      and t4.code!='21'
                                      and t4.code in ('1','3')
                          )t  
                        inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                   from (
                                         select f.card_no,f.out_date oper_date
                                          from fin_ipr_inmaininfo f 
                                         where f.dept_code='1010'
                                           and f.in_state&lt;&gt;'N'
                                           and f.patient_no not like 'B%'
                                           and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                        )t
                                   inner join (  
                                               select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      ,replace(cd.name,'套餐','')  type
                                                 from exp_package ep 
                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                  and cd.code in ('1','3')
                                                  and ep.pay_flag=1 
                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                  and  bp.package_name not like '%自选包%' 
                                                  and bp.package_name not like '%无痛%' 
                                                  and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                group by t.card_no,type,t.oper_date
                                       ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                          group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                           ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                    union all
                    select hospitalname,  
                           name patientname,
                           phone phone,
                           firstname,
                           wm_concat(distinct secondname) secondname,
                           wm_concat(distinct packagename) packagename,
                           case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                  else 0 end amount,
                           round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                           to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                           to_char(out_date,'yyyy-mm-dd') out_date,
                           channel1,
                           channel2
                     from (       
                           select   replace(t4.name,'套餐','')  firstname, ---产检 
                                     t3.package_name packagename,
                                      t.invoice_no invoice_no,
                                      t.real_cost invoice_real,
                                      t2.real_cost,
                                     cp.name,
                                      t2.oper_date oper_date,
                                      nvl((select sum(a.real_cost)
                                             from exp_packagepaymode a
                                            where a.invoice_no = t.invoice_no
                                                  and a.trans_type = t.trans_type 
                                                  and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                      ,decode(t2.trans_type,1,1,2,'-1') amount
                                      ,t7.package_name secondname
                                      ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                      ,cp.channel1
                                      ,cp.channel2
                                      ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                      ,t2.card_no
                                 from exp_packageinvoice t
                                 left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                 left join bd_com_package t3 on t2.package_id = t3.package_id
                                 left join bd_com_package t7 on t3.parent_code=t7.package_id
                                 left join com_patientinfo cp on t2.card_no=cp.card_no
                                 left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                      and t4.code!='21'
                                      and t4.code in ('4')
                                      and t.trans_type = t2.trans_type
                              )tt 
                          inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                         from (
                                               select f.card_no,f.out_date oper_date
                                                from fin_ipr_inmaininfo f 
                                               where f.dept_code='1010'
                                                 and f.in_state&lt;&gt;'N'
                                                 and f.patient_no not like 'B%'
                                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                              )t
                                         inner join (  
                                                    select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                      from exp_package ep 
                                                      left join bd_com_package bp on ep.package_id=bp.package_id
                                                      left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3) 
                                                       and cd.code in ('4')
                                                       and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                          group by t.card_no,t.oper_date
                                               ) ep3 on tt.card_no=ep3.card_no
                          group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                   ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                       union all 
                      select HOSPITALNAME, 
                             PATIENTNAME, 
                             PHONE, 
                             FIRSTNAME, 
                             SECONDNAME, 
                             PACKAGENAME, 
                             case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                             CASHCOST, 
                             to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                             to_char(t.out_date,'yyyy-mm-dd'), 
                             CHANNEL1, 
                             CHANNEL2 
                      from (
                               select f.card_no,f.out_date out_date
                                from fin_ipr_inmaininfo f 
                               where f.dept_code='1010'
                                 and f.in_state&lt;&gt;'N'
                                 and f.patient_no not like 'B%'
                                 and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                              )t
                     inner join (  
                                   select  hospitalname,   
                                        name patientname,
                                        phone phone,
                                        firstname,
                                        wm_concat(distinct secondname) secondname,
                                        wm_concat(distinct packagename) packagename,
                                        trans amount,
                                        round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                        oper_date,
                                        channel1,
                                        channel2,
                                        card_no,
                                        invoice_no
                                 from (       
                                      select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 广州
                                             t3.package_name packagename,
                                              t.invoice_no invoice_no,
                                              t.real_cost invoice_real,
                                              t2.real_cost,
                                             cp.name,
                                              t2.oper_date oper_date,
                                              nvl((select sum(a.real_cost)
                                                     from exp_packagepaymode a
                                                    where a.invoice_no = t.invoice_no
                                                          and a.trans_type = t.trans_type 
                                                          and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                              ,case when t3.package_name like '%自选包%' then  0 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                    when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                              ,t7.package_name secondname
                                              ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                              , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                              ,cp.channel1
                                              ,cp.channel2
                                              ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                              ,t2.card_no
                                              ,decode(t2.trans_type,1,1,2,-1) trans
                                         from exp_packageinvoice t
                                         left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                         left join bd_com_package t3 on t2.package_id = t3.package_id
                                         left join bd_com_package t7 on t3.parent_code=t7.package_id
                                         left join com_patientinfo cp on t2.card_no=cp.card_no
                                         left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                        where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,3)  
                                              and t4.code!='21'
                                              and t4.code in ('2','7','8','9','10','22','23','24')
                                              and t.trans_type = t2.trans_type
                                   )tt 
                                  group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t4
                  union all
                 select  '第五个月' type,t5.*，'套餐' line
                   from (
                         ---第五个月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                            t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                            cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                      union all
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                  when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                       from (       
                             select   replace(t4.name,'套餐','')  firstname, ---产检 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,'-1') amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                        and t4.code!='21'
                                        and t4.code in ('4')
                                        and t.trans_type = t2.trans_type
                                )tt 
                            inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                           from (
                                                 select f.card_no,f.out_date oper_date
                                                  from fin_ipr_inmaininfo f 
                                                 where f.dept_code='1010'
                                                   and f.in_state&lt;&gt;'N'
                                                   and f.patient_no not like 'B%'
                                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                )t
                                           inner join (  
                                                      select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        from exp_package ep 
                                                        left join bd_com_package bp on ep.package_id=bp.package_id
                                                        left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                       where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4) 
                                                         and cd.code in ('4')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,t.oper_date
                                                 ) ep3 on tt.card_no=ep3.card_no
                            group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                     ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                         union all 
                        select HOSPITALNAME, 
                               PATIENTNAME, 
                               PHONE, 
                               FIRSTNAME, 
                               SECONDNAME, 
                               PACKAGENAME, 
                               case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                               CASHCOST, 
                               to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                               to_char(t.out_date,'yyyy-mm-dd'), 
                               CHANNEL1, 
                               CHANNEL2 
                        from (
                                 select f.card_no,f.out_date out_date
                                  from fin_ipr_inmaininfo f 
                                 where f.dept_code='1010'
                                   and f.in_state&lt;&gt;'N'
                                   and f.patient_no not like 'B%'
                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                )t
                       inner join (  
                                     select  hospitalname,   
                                          name patientname,
                                          phone phone,
                                          firstname,
                                          wm_concat(distinct secondname) secondname,
                                          wm_concat(distinct packagename) packagename,
                                          trans amount,
                                          round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                          oper_date,
                                          channel1,
                                          channel2,
                                          card_no,
                                          invoice_no
                                   from (       
                                        select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 
                                               t3.package_name packagename,
                                                t.invoice_no invoice_no,
                                                t.real_cost invoice_real,
                                                t2.real_cost,
                                               cp.name,
                                                t2.oper_date oper_date,
                                                nvl((select sum(a.real_cost)
                                                       from exp_packagepaymode a
                                                      where a.invoice_no = t.invoice_no
                                                            and a.trans_type = t.trans_type 
                                                            and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                ,case when t3.package_name like '%自选包%' then  0 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                ,t7.package_name secondname
                                                ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                ,cp.channel1
                                                ,cp.channel2
                                                ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                ,t2.card_no
                                                ,decode(t2.trans_type,1,1,2,-1) trans
                                           from exp_packageinvoice t
                                           left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                           left join bd_com_package t3 on t2.package_id = t3.package_id
                                           left join bd_com_package t7 on t3.parent_code=t7.package_id
                                           left join com_patientinfo cp on t2.card_no=cp.card_no
                                           left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                          where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,4)  
                                                and t4.code!='21'
                                                and t4.code in ('2','7','8','9','10','22','23','24')
                                                and t.trans_type = t2.trans_type
                                     )tt 
                                    group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t5                                               
                  union all
                 select  '第六个月' type,t6.*,'套餐' line
                   from (
                           ---第六个月
                          select hospitalname,  
                                 name patientname,
                                 phone phone,
                                 firstname,
                                 wm_concat(distinct secondname) secondname,
                                 wm_concat(distinct packagename) packagename,
                                 case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0  then 1
                                      when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 
                                        else 0 end amount,
                                 round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                 to_char(oper_date,'yyyy-mm-dd') oper_date,
                                 to_char(out_date,'yyyy-mm-dd') out_date,
                                 channel1,
                                 channel2
                               -- ,invoice_no invoice_no
                           
                            from (        --妇科、生活美容、LPG、中医科、其他  
                                    select case when t4.code in ('11','14','5','19') then '妇科' else replace(t4.name,'套餐','') end  firstname,
                                           t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                           cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,case when t3.package_name like '%自选包%' then  0 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                  when t3.package_name not like '%自选包%' and t2.trans_type=2 then -1 end amount
                                            ,t7.package_name secondname
                                            ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                            and t4.code!='21'
                                            and t4.code in ('12','14','11','17','13', '19','5','20'，'16')
                                            and t.trans_type = t2.trans_type
                                    union all---医美 
                                    select  case when t4.code ='15' then '居家月子' else '医美' end  firstname,
                                            t3.package_name packagename,
                                            t.invoice_no invoice_no,
                                            t.real_cost invoice_real,
                                            t2.real_cost,
                                            cp.name,
                                            t2.oper_date oper_date,
                                            nvl((select sum(a.real_cost)
                                                   from exp_packagepaymode a
                                                  where a.invoice_no = t.invoice_no
                                                        and a.trans_type = t.trans_type 
                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                            ,t7.package_name secondname
                                            ,case when cp.home_tel like '%-%' or cp.home_tel is null then cp.linkman_tel else cp.home_tel end phone
                                            , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                            ,cp.channel1
                                            ,cp.channel2
                                            ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                            ,t2.card_no
                                       from exp_packageinvoice t
                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                            and t4.code!='21'
                                            and t4.code in ('25'，'6','15')
                                            and t.trans_type = t2.trans_type
                                   )tt 
                          inner join (select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount3,type,t.oper_date out_date
                                       from (
                                             select f.card_no,f.out_date oper_date
                                              from fin_ipr_inmaininfo f 
                                             where f.dept_code='1010'
                                               and f.in_state&lt;&gt;'N'
                                               and f.patient_no not like 'B%'
                                               and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                            )t
                                       inner join (  
                                                   select   distinct ep.card_no,ep.oper_date,ep.trans_type,ep.invoice_no
                                                          ,case when cd.code in ('11','14','5','19') then '妇科' when cd.code in ('25','6') then '医美'  else replace(cd.name,'套餐','') end type
                                                     from exp_package ep 
                                                     left join bd_com_package bp on ep.package_id=bp.package_id
                                                     left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                     where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                           and cd.code in ('25','6','12','14','11','17','13', '19','5','20'，'16','15')
                                                           and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,type,t.oper_date
                                             ) ep3 on tt.card_no=ep3.card_no  and ep3.type=tt.firstname
                                group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd') ,channel1,channel2
                                         ,case when oper_date=ep3.oper_date3 and ep3.amount3&gt;0 then 1 when oper_date=ep3.oper_date3 and ep3.amount3&lt;0 then -1 else 0 end 
                          union all
                         select hospitalname, 
                                name patientname,
                                phone phone,
                                firstname,
                                wm_concat(distinct secondname) secondname,
                                wm_concat(distinct packagename) packagename,
                               case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 
                                    when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1
                                      else 0 end amount,
                               round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                               to_char(oper_date,'yyyy-mm-dd'),
                               to_char(out_date,'yyyy-mm-dd'),
                               channel1,
                               channel2
                          from (  
                              select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                        t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                        cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,-1) amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                               and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                               then replace(t4.name,'套餐','')
                                              else replace(t4.name,'套餐','')||'加收' end  firstname
                                        ,cp.channel1
                                        ,cp.channel2
                                         ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                        ,t8.invoice_no i
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join (select ep.* 
                                               from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                              where epd.clinic_code=ep.clinic_code 
                                                and epd.trans_type=ep.trans_type
                                                and ep.package_id=bp.package_id 
                                                and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                        and t4.code!='21'
                                        and t4.code in ('1','3')
                            )t  
                          inner join (  select t.card_no,min(t1.oper_date) oper_date3,sum(decode(t1.trans_type,1,1,2,-1)) amount,type,t.oper_date out_date
                                     from (
                                           select f.card_no,f.out_date oper_date
                                            from fin_ipr_inmaininfo f 
                                           where f.dept_code='1010'
                                             and f.in_state&lt;&gt;'N'
                                             and f.patient_no not like 'B%'
                                             and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                          )t
                                     inner join (  
                                                 select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        ,replace(cd.name,'套餐','')  type
                                                   from exp_package ep 
                                                   left join bd_com_package bp on ep.package_id=bp.package_id
                                                   left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                  where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                    and cd.code in ('1','3')
                                                    and ep.pay_flag=1 
                                                    and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                    and  bp.package_name not like '%自选包%' 
                                                    and bp.package_name not like '%无痛%' 
                                                    and bp.package_name not like '%赠送%' )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                                  group by t.card_no,type,t.oper_date
                                         ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                            group by hospitalname,name,phone,firstname,to_char(oper_date,'yyyy-mm-dd'),to_char(out_date,'yyyy-mm-dd'), channel1,channel2
                             ,case when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&gt;0 then 1 when  firstname not like '%加收%' and oper_date=ep3.oper_date3 and ep3.amount&lt;0 then -1 else 0 end  
                      union all
                      select hospitalname,  
                             name patientname,
                             phone phone,
                             firstname,
                             wm_concat(distinct secondname) secondname,
                             wm_concat(distinct packagename) packagename,
                             case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 
                                  when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1
                                    else 0 end amount,
                             round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                             to_char(tt.oper_date,'yyyy-mm-dd') oper_date,
                             to_char(out_date,'yyyy-mm-dd') out_date,
                             channel1,
                             channel2
                       from (       
                             select   replace(t4.name,'套餐','')  firstname, ---产检 
                                       t3.package_name packagename,
                                        t.invoice_no invoice_no,
                                        t.real_cost invoice_real,
                                        t2.real_cost,
                                       cp.name,
                                        t2.oper_date oper_date,
                                        nvl((select sum(a.real_cost)
                                               from exp_packagepaymode a
                                              where a.invoice_no = t.invoice_no
                                                    and a.trans_type = t.trans_type 
                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                        ,decode(t2.trans_type,1,1,2,'-1') amount
                                        ,t7.package_name secondname
                                        ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                        ,cp.channel1
                                        ,cp.channel2
                                        ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                        ,t2.card_no
                                   from exp_packageinvoice t
                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                  where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                        and t4.code!='21'
                                        and t4.code in ('4')
                                        and t.trans_type = t2.trans_type
                                )tt 
                            inner join (  select t.card_no,min(t1.oper_date) oper_date,sum(decode(t1.trans_type,1,1,2,-1)) amount,t.oper_date out_date
                                           from (
                                                 select f.card_no,f.out_date oper_date
                                                  from fin_ipr_inmaininfo f 
                                                 where f.dept_code='1010'
                                                   and f.in_state&lt;&gt;'N'
                                                   and f.patient_no not like 'B%'
                                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                )t
                                           inner join (  
                                                      select  distinct ep.card_no,ep.invoice_no,ep.trans_type,ep.oper_date
                                                        from exp_package ep 
                                                        left join bd_com_package bp on ep.package_id=bp.package_id
                                                        left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                       where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5) 
                                                         and cd.code in ('4')
                                                         and ep.pay_flag=1 )t1 on t.card_no=t1.card_no and t.oper_date&lt;t1.oper_date
                                            group by t.card_no,t.oper_date
                                                 ) ep3 on tt.card_no=ep3.card_no
                            group by hospitalname,name,phone,firstname,to_char(tt.oper_date,'yyyy-mm-dd'), to_char(out_date,'yyyy-mm-dd'),channel1,channel2
                                     ,case when ep3.amount&gt;0 and ep3.oper_date=tt.oper_date then 1 when ep3.amount&lt;0 and ep3.oper_date=tt.oper_date then -1 else 0 end 
                         union all 
                        select HOSPITALNAME, 
                               PATIENTNAME, 
                               PHONE, 
                               FIRSTNAME, 
                               SECONDNAME, 
                               PACKAGENAME, 
                               case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                               CASHCOST, 
                               to_char(t1.OPER_DATE,'yyyy-mm-dd') OPER_DATE,
                               to_char(t.out_date,'yyyy-mm-dd'), 
                               CHANNEL1, 
                               CHANNEL2 
                        from (
                                 select f.card_no,f.out_date out_date
                                  from fin_ipr_inmaininfo f 
                                 where f.dept_code='1010'
                                   and f.in_state&lt;&gt;'N'
                                   and f.patient_no not like 'B%'
                                   and f.out_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                )t
                       inner join (  
                                     select  hospitalname,   
                                          name patientname,
                                          phone phone,
                                          firstname,
                                          wm_concat(distinct secondname) secondname,
                                          wm_concat(distinct packagename) packagename,
                                          trans amount,
                                          round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                          oper_date,
                                          channel1,
                                          channel2,
                                          card_no,
                                          invoice_no
                                   from (       
                                        select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊 广州
                                               t3.package_name packagename,
                                                t.invoice_no invoice_no,
                                                t.real_cost invoice_real,
                                                t2.real_cost,
                                               cp.name,
                                                t2.oper_date oper_date,
                                                nvl((select sum(a.real_cost)
                                                       from exp_packagepaymode a
                                                      where a.invoice_no = t.invoice_no
                                                            and a.trans_type = t.trans_type 
                                                            and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                ,case when t3.package_name like '%自选包%' then  0 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                      when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                ,t7.package_name secondname
                                                ,case when (cp.home_tel like '%-%' or cp.home_tel is null) then cp.linkman_tel else cp.home_tel end phone
                                                , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                ,cp.channel1
                                                ,cp.channel2
                                                ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                ,t2.card_no
                                                ,decode(t2.trans_type,1,1,2,-1) trans
                                           from exp_packageinvoice t
                                           left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                           left join bd_com_package t3 on t2.package_id = t3.package_id
                                           left join bd_com_package t7 on t3.parent_code=t7.package_id
                                           left join com_patientinfo cp on t2.card_no=cp.card_no
                                           left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                          where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 ,5)  
                                                and t4.code!='21'
                                                and t4.code in ('2','7','8','9','10','22','23','24')
                                                and t.trans_type = t2.trans_type
                                     )tt 
                                    group by hospitalname,name,phone,firstname,oper_date, channel1,channel2 ,card_no,invoice_no,trans)t1 on t.card_no=t1.card_no and t.out_date&lt;t1.oper_date  )t6
                  ) t9 on t7.line=t9.line and t7.name=t9.firstname
                  where t9.patientname is not null
                  group by t9.patientname,t8.amount)t10 group by t10.amount
                  )t11
                  where t11.name='&amp;name' or '&amp;name'='ALL'
                                                                                                       
                                                                                                                                                            </Sql><AddMapRow>false</AddMapRow><AddMapColumn>true</AddMapColumn><AddMapData>true</AddMapData><AddMapSourceData>false</AddMapSourceData><IsCross>false</IsCross><SqlType>MainReportUsing</SqlType><CrossRows></CrossRows><CrossColumns></CrossColumns><CrossValues></CrossValues><CrossCombinColumns></CrossCombinColumns><SumColumns></SumColumns><CrossGroupColumns></CrossGroupColumns><IsSumRow>true</IsSumRow><SumRows></SumRows><RowGroup /></QueryDataSource></QueryDataSource><QueryFilePath>Report\数据分析\新月子中心客户套餐转化率设置.xml</QueryFilePath><PrintInfo Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.PrintInfo,SOC.HISFC.OutpatientFee.Components"><PaperSize Type="System.Drawing.Printing.PaperSize,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Height>1169</Height><PaperName>A4</PaperName><RawKind>0</RawKind><Width>850</Width></PaperSize><SelectPage>false</SelectPage></PrintInfo></ReportQueryInfo>