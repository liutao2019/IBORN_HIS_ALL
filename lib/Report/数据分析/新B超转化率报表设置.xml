<ReportQueryInfo Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.ReportQueryInfo,SOC.HISFC.OutpatientFee.Components"><List><List Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryControl,SOC.HISFC.OutpatientFee.Components"><Index>0</Index><Name>dtBeginTime</Name><Text>开始时间：</Text><IsAddText>true</IsAddText><ControlType Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.ControlType.DateTimeType,SOC.HISFC.OutpatientFee.Components"><AddDays>-1</AddDays><AddMonths>0</AddMonths><CustomFormat>yyyy-MM-dd</CustomFormat><DefaultDataSource></DefaultDataSource><Format>Custom</Format><IsLike>false</IsLike><LikeStr>%{0}%</LikeStr><Size Type="System.Drawing.Size,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Width>120</Width><Height>20</Height></Size><Location Type="System.Drawing.Point,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><X>10</X><Y>2</Y></Location><QueryDataSource>Dictionary</QueryDataSource><DataSourceTypeName></DataSourceTypeName><Enabled>true</Enabled></ControlType></List><List Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryControl,SOC.HISFC.OutpatientFee.Components"><Index>1</Index><Name>dtEndTime</Name><Text>结束时间：</Text><IsAddText>true</IsAddText><ControlType Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.ControlType.DateTimeType,SOC.HISFC.OutpatientFee.Components"><AddDays>0</AddDays><AddMonths>0</AddMonths><CustomFormat>yyyy-MM-dd</CustomFormat><DefaultDataSource></DefaultDataSource><Format>Custom</Format><IsLike>false</IsLike><LikeStr>%{0}%</LikeStr><Size Type="System.Drawing.Size,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Width>120</Width><Height>20</Height></Size><Location Type="System.Drawing.Point,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><X>220</X><Y>2</Y></Location><QueryDataSource>Dictionary</QueryDataSource><DataSourceTypeName></DataSourceTypeName><Enabled>true</Enabled></ControlType></List></List><QueryDataSource><QueryDataSource Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryDataSource,SOC.HISFC.OutpatientFee.Components"><Name>dtDataSource</Name><Sql>      select   FIRSTNAME, 
               非套餐B超人数, 
               sum(第一个月转化人次) 第一个月转化人次,
               to_char(round(sum(第一个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第一个月转化率, 
               sum(第二个月转化人次) 第二个月转化人次,
               to_char(round(sum(第二个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第二个月转化率, 
               sum(第三个月转化人次) 第三个月转化人次, 
               to_char(round(sum(第三个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第三个月转化率,
               sum(第四个月转化人次) 第四个月转化人次, 
               to_char(round(sum(第四个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第四个月转化率,
               sum(第五个月转化人次) 第五个月转化人次, 
               to_char(round(sum(第五个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第五个月转化率,
               sum(第六个月转化人次) 第六个月转化人次,
               to_char(round(sum(第六个月转化人次)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第六个月转化率,
               sum(第一个月转化人次)+sum(第二个月转化人次)+sum(第三个月转化人次)
               +sum(第四个月转化人次)+sum(第五个月转化人次)+sum(第六个月转化人次) 合计,
               to_char(round((sum(第一个月转化人次)+sum(第二个月转化人次)+sum(第三个月转化人次)
               +sum(第四个月转化人次)+sum(第五个月转化人次)+sum(第六个月转化人次))/非套餐B超人数*100,2),'fm999990.99999')||'%' 合计转化率
        from (   
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    sum(case when t2.amount&gt;0 then 1 when t2.amount&lt;0 then -1 else 0 end) 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第一个月/本月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                     PATIENTNAME, 
                                     card_no, 
                                     FIRSTNAME, 
                                     case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                                     CASHCOST, 
                                     OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t2 on t1.card_no=t2.card_no and t1.reg_date&lt;t2.oper_date and t2.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t9.name,t8.amount 
              union all
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    sum(case when t3.amount&gt;0 then 1 when t3.amount&lt;0 then -1 else 0 end) 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第二个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount, 
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                   ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t3 on t1.card_no=t3.card_no and t1.reg_date&lt;t3.oper_date and t3.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t9.name,t8.amount 
              union all
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    sum(case when t4.amount&gt;0 then 1 when t4.amount&lt;0 then -1 else 0 end) 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第三个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                   ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t4 on t1.card_no=t4.card_no and t1.reg_date&lt;t4.oper_date and t4.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t9.name,t8.amount 
             union all
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    sum(case when t5.amount&gt;0 then 1 when t5.amount&lt;0 then -1 else 0 end) 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第四个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t5 on t1.card_no=t5.card_no and t1.reg_date&lt;t5.oper_date and t5.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t9.name,t8.amount 
              union all
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    sum(case when t6.amount&gt;0 then 1 when t6.amount&lt;0 then -1 else 0 end) 第五个月转化人次,
                    0 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第五个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t6 on t1.card_no=t6.card_no and t1.reg_date&lt;t6.oper_date and t6.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t9.name,t8.amount 
              union all
             select  t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    sum(case when t7.amount&gt;0 then 1 when t7.amount&lt;0 then -1 else 0 end) 第六个月转化人次
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第六个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t7 on t1.card_no=t7.card_no and t1.reg_date&lt;t7.oper_date and t7.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t9.name,t8.amount 
             )t10
             group by FIRSTNAME, 非套餐B超人数</Sql><AddMapRow>false</AddMapRow><AddMapColumn>false</AddMapColumn><AddMapData>false</AddMapData><AddMapSourceData>false</AddMapSourceData><IsCross>false</IsCross><SqlType>MainReportUsing</SqlType><CrossRows></CrossRows><CrossColumns></CrossColumns><CrossValues></CrossValues><CrossCombinColumns></CrossCombinColumns><SumColumns></SumColumns><CrossGroupColumns></CrossGroupColumns><IsSumRow>true</IsSumRow><SumRows></SumRows><RowGroup /></QueryDataSource><QueryDataSource Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.QueryDataSource,SOC.HISFC.OutpatientFee.Components"><Name>dtDataSource1</Name><Sql>      select   '合计' FIRSTNAME, 
               非套餐B超人数, 
               sum(case when 第一个月转化人次&gt;0 then 1 when 第一个月转化人次&lt;0 then -1 else 0 end ) 第一个月转化人次,
               to_char(round(sum(case when 第一个月转化人次&gt;0 then 1 when 第一个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第一个月转化率, 
               sum(case when 第二个月转化人次&gt;0 then 1 when 第二个月转化人次&lt;0 then -1 else 0 end) 第二个月转化人次,
               to_char(round(sum(case when 第二个月转化人次&gt;0 then 1 when 第二个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第二个月转化率, 
               sum(case when 第三个月转化人次&gt;0 then 1 when 第三个月转化人次&lt;0 then -1 else 0 end) 第三个月转化人次, 
               to_char(round(sum(case when 第三个月转化人次&gt;0 then 1 when 第三个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第三个月转化率,
               sum(case when 第四个月转化人次&gt;0 then 1 when 第四个月转化人次&lt;0 then -1 else 0 end) 第四个月转化人次, 
               to_char(round(sum(case when 第四个月转化人次&gt;0 then 1 when 第四个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第四个月转化率,
               sum(case when 第五个月转化人次&gt;0 then 1 when 第五个月转化人次&lt;0 then -1 else 0 end) 第五个月转化人次, 
               to_char(round(sum(case when 第五个月转化人次&gt;0 then 1 when 第五个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第五个月转化率,
               sum(case when 第六个月转化人次&gt;0 then 1 when 第六个月转化人次&lt;0 then -1 else 0 end) 第六个月转化人次,
               to_char(round(sum(case when 第六个月转化人次&gt;0 then 1 when 第六个月转化人次&lt;0 then -1 else 0 end)/非套餐B超人数*100,2),'fm999990.99999')||'%' 第六个月转化率,
               sum(case when 第一个月转化人次&gt;0 then 1 when 第一个月转化人次&lt;0 then -1 else 0 end )
               +sum(case when 第二个月转化人次&gt;0 then 1 when 第二个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第三个月转化人次&gt;0 then 1 when 第三个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第四个月转化人次&gt;0 then 1 when 第四个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第五个月转化人次&gt;0 then 1 when 第五个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第六个月转化人次&gt;0 then 1 when 第六个月转化人次&lt;0 then -1 else 0 end) 合计,
               to_char(round((sum(case when 第一个月转化人次&gt;0 then 1 when 第一个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第二个月转化人次&gt;0 then 1 when 第二个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第三个月转化人次&gt;0 then 1 when 第三个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第四个月转化人次&gt;0 then 1 when 第四个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第五个月转化人次&gt;0 then 1 when 第五个月转化人次&lt;0 then -1 else 0 end)
               +sum(case when 第六个月转化人次&gt;0 then 1 when 第六个月转化人次&lt;0 then -1 else 0 end))/非套餐B超人数*100,2),'fm999990.99999')||'%' 合计转化率
        from (  
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    sum(case when t2.amount&gt;0 then 1 when t2.amount&lt;0 then -1 else 0 end) 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
                    ,t2.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第一个月/本月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between to_date('&amp;dtBeginTime','yyyy-mm-dd') and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99 
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t2 on t1.card_no=t2.card_no and t1.reg_date&lt;t2.oper_date and t2.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t8.amount ,t2.card_no
              union all
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    sum(case when t3.amount&gt;0 then 1 when t3.amount&lt;0 then -1 else 0 end) 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
                    ,t3.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第二个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT, 
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),1) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,1)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t3 on t1.card_no=t3.card_no and t1.reg_date&lt;t3.oper_date and t3.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t8.amount ,t3.card_no
              union all
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    sum(case when t4.amount&gt;0 then 1 when t4.amount&lt;0 then -1 else 0 end) 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
                    ,t4.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第三个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),2) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,2)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t4 on t1.card_no=t4.card_no and t1.reg_date&lt;t4.oper_date and t4.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t8.amount ,t4.card_no
             union all
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    sum(case when t5.amount&gt;0 then 1 when t5.amount&lt;0 then -1 else 0 end) 第四个月转化人次,
                    0 第五个月转化人次,
                    0 第六个月转化人次
                    ,t5.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第四个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,  
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                   ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),3) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,3)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t5 on t1.card_no=t5.card_no and t1.reg_date&lt;t5.oper_date and t5.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t8.amount ,t5.card_no
              union all
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    sum(case when t6.amount&gt;0 then 1 when t6.amount&lt;0 then -1 else 0 end) 第五个月转化人次,
                    0 第六个月转化人次
                    ,t6.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第五个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                            trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),4) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,4)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t6 on t1.card_no=t6.card_no and t1.reg_date&lt;t6.oper_date and t6.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
              group by t8.amount,t6.card_no 
              union all
             select  --t9.name FIRSTNAME,
                    t8.amount 非套餐B超人数,
                    0 第一个月转化人次,
                    0 第二个月转化人次,
                    0 第三个月转化人次,
                    0 第四个月转化人次,
                    0 第五个月转化人次,
                    sum(case when t7.amount&gt;0 then 1 when t7.amount&lt;0 then -1 else 0 end) 第六个月转化人次
                    ,t7.card_no
              from (   
                  select    NAME, CARD_NO, DEPT_NAME,REG_DATE, AMOUNT 
                      from (  
                          select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  
               )t1
             left join (select replace(cd.name,'套餐','') name,'B超' dept_name from com_dictionary cd 
                         where cd.type='PACKAGETYPE' and cd.code in ('1','2','3','4')) t9 on t9.dept_name=t1.dept_name
             left join (---第六个月
                         select HOSPITALNAME，
                                PATIENTNAME，
                                card_no，
                                FIRSTNAME，
                                amount ,
                                OPER_DATE 
                           from ( 
                           select HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME, sum(AMOUNT) AMOUNT,OPER_DATE 
                             from (
                                       select  HOSPITALNAME, 
                                              PATIENTNAME, 
                                              t.CARD_NO, 
                                              FIRSTNAME,
                                              case when t.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when t.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                              CASHCOST, 
                                              t.OPER_DATE 
                                        from(
                                           select hospitalname, 
                                                    name patientname,
                                                    t.card_no card_no,
                                                    firstname,
                                                   round(sum(case when (invoice_real = 0 or i is not null) then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                   to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                             from (  
                                                  select --replace(t4.name,'套餐','')   firstname,  --分娩、月子 
                                                           t3.package_name packagename,
                                                            t.invoice_no invoice_no,
                                                            t.real_cost invoice_real,
                                                            t2.real_cost,
                                                           cp.name,
                                                            t2.oper_date oper_date,
                                                            nvl((select sum(a.real_cost)
                                                                   from exp_packagepaymode a
                                                                  where a.invoice_no = t.invoice_no
                                                                        and a.trans_type = t.trans_type 
                                                                        and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                            ,decode(t2.trans_type,1,1,2,-1) amount
                                                            ,t7.package_name secondname
                                                            ,t2.card_no card_no
                                                            ,case when （t3.package_name like '%顺产%' or t3.package_name like '%剖宫产%' or t3.package_name like '%基础包%'）
                                                                   and  t3.package_name not like '%自选包%' and t3.package_name not like '%无痛%' and t3.package_name not like '%赠送%' 
                                                                   then replace(t4.name,'套餐','')
                                                                  else replace(t4.name,'套餐','')||'加收' end  firstname
                                                             ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                            ,t8.invoice_no i
                                                       from exp_packageinvoice t
                                                       left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                       left join (select ep.* 
                                                                   from exp_packagedetail epd ,exp_package ep,bd_com_package bp  
                                                                  where epd.clinic_code=ep.clinic_code 
                                                                    and epd.trans_type=ep.trans_type
                                                                    and ep.package_id=bp.package_id 
                                                                    and epd.item_name like '%脐带血造血干细胞储存费%' ) t8 on t2.clinic_code=t8.clinic_code and t2.trans_type=t8.trans_type and t2.invoice_no=t8.invoice_no and t2.package_id=t8.package_id
                                                       left join bd_com_package t3 on t2.package_id = t3.package_id
                                                       left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                       left join com_patientinfo cp on t2.card_no=cp.card_no
                                                       left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                      where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                            and t4.code!='21'
                                                            and t4.code in ('1','3')
                                                )t  
                                                where firstname not like '%加收%'
                                                group by hospitalname,name,t.card_no,firstname,to_char(oper_date,'yyyy-mm-dd hh24:mi')
                                                )t
                                        left join (   select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount,type
                                                        from (  select  --ep.card_no,min(ep.oper_date) oper_date3,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                                      distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                                      ,replace(cd.name,'套餐','')  type
                                                                 from exp_package ep 
                                                                 left join bd_com_package bp on ep.package_id=bp.package_id
                                                                 left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                                where ep.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                                  and cd.code in ('1','3')
                                                                  and ep.pay_flag=1 
                                                                  and （bp.package_name like '%顺产%' or bp.package_name like '%剖宫产%' or bp.package_name like '%基础包%'）
                                                                  and  bp.package_name not like '%自选包%' 
                                                                  and bp.package_name not like '%无痛%' 
                                                                  and bp.package_name not like '%赠送%')ep
                                                                group by ep.card_no,type
                                                             ) ep3 on t.card_no=ep3.card_no  and ep3.type=t.firstname
                                  union all 
                                 select HOSPITALNAME, 
                                   PATIENTNAME, 
                                   tt.CARD_NO, 
                                   FIRSTNAME,
                                   case when tt.oper_date=ep3.oper_date and ep3.amount&gt;0 then 1 when tt.oper_date=ep3.oper_date and ep3.amount&lt;0 then -1 else 0 end amount, 
                                   CASHCOST, 
                                   tt.OPER_DATE  
                              from (
                                 select hospitalname,  
                                        name patientname,
                                        tt.card_no card_no,
                                        firstname,
                                       round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                       to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                   from (       
                                       select   replace(t4.name,'套餐','')  firstname, ---产检 
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,decode(t2.trans_type,1,1,2,'-1') amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5)  
                                                  and t4.code!='21'
                                                  and t4.code in ('4')
                                                  and t.trans_type = t2.trans_type
                                          )tt 
                                      group by hospitalname,name,tt.card_no,firstname,to_char(tt.oper_date,'yyyy-mm-dd hh24:mi') )tt
                                      left join ( select ep.card_no,min(ep.oper_date) oper_date,sum(decode(ep.trans_type,1,1,2,-1)) amount
                                                    from (  select  distinct ep.card_no,ep.invoice_no,ep.trans_type,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date
                                                              from exp_package ep 
                                                              left join bd_com_package bp on ep.package_id=bp.package_id
                                                              left join com_dictionary cd on bp.package_kind=cd.code and cd.type='PACKAGETYPE' 
                                                             where ep.oper_date between to_date(to_char(to_date('&amp;dtBeginTime','yyyy-mm-dd') - interval '10' month,'YYYY-MM-DD'),'YYYY-MM-DD') and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5) 
                                                               and cd.code in ('4')
                                                               and ep.pay_flag=1 )ep
                                                             group by ep.card_no
                                                           ) ep3 on tt.card_no=ep3.card_no
                                 union all  
                                select HOSPITALNAME, 
                                       PATIENTNAME, 
                                       card_no, 
                                       FIRSTNAME, 
                                       case when CASHCOST&gt;1000 then 1  when CASHCOST&lt;=1000 and amount &gt;=0 then 0 when CASHCOST&lt;=1000 and amount&lt;0 then -1 else 0 end AMOUNT,
                                       CASHCOST, 
                                       OPER_DATE
                                from (
                                    select  hospitalname,
                                            name patientname,
                                            card_no card_no,
                                            firstname,
                                            wm_concat(distinct secondname) secondname,
                                            wm_concat(distinct packagename) packagename,
                                             trans amount,
                                            round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                            to_char(oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                            invoice_no
                                     from (       
                                          select case when t4.name like '%综%' then '综' else replace(t4.name,'套餐','') end  firstname, --儿保、综合门诊  广州
                                                 t3.package_name packagename,
                                                  t.invoice_no invoice_no,
                                                  t.real_cost invoice_real,
                                                  t2.real_cost,
                                                 cp.name,
                                                  t2.oper_date oper_date,
                                                  nvl((select sum(a.real_cost)
                                                         from exp_packagepaymode a
                                                        where a.invoice_no = t.invoice_no
                                                              and a.trans_type = t.trans_type 
                                                              and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                  ,case when t3.package_name like '%自选包%' then  0 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                        when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                  ,t7.package_name secondname
                                                  ,t2.card_no card_no
                                                  , case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                  ,case when t.print_invoiceno like 'IB%' then '广州爱博恩妇产医院' else '爱博恩医疗门诊部' end  hospitalname
                                                  ,decode(t2.trans_type,1,1,2,-1) trans
                                             from exp_packageinvoice t
                                             left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                             left join bd_com_package t3 on t2.package_id = t3.package_id
                                             left join bd_com_package t7 on t3.parent_code=t7.package_id
                                             left join com_patientinfo cp on t2.card_no=cp.card_no
                                             left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                            where t.oper_date between add_months(to_date('&amp;dtBeginTime','yyyy-mm-dd'),5) and add_months(to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99,5)  
                                                  and t4.code!='21'
                                                  and t4.code in ('2')
                                                  and t.trans_type = t2.trans_type
                                       )tt 
                                      group by hospitalname,name,card_no,firstname,to_char(OPER_DATE,'yyyy-mm-dd hh24:mi'),invoice_no,trans)ttt
                                      )t1  
                                      group by HOSPITALNAME, PATIENTNAME, card_no, FIRSTNAME,OPER_DATE 
                               )tt
             )t7 on t1.card_no=t7.card_no and t1.reg_date&lt;t7.oper_date and t7.FIRSTNAME=t9.name
             left join ( --合计
                           select '合计' name,'','B超' dept_name,to_char(sysdate,'yyyy-mm-dd hh24:mi'),count(name) amount 
                            from (  
                                select  r.name,
                                  r.card_no,
                                  case when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is null and ep.oper_date is null then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then 'B超'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is null and ep.oper_date is null then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&gt;to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       when cdt.pardep_name='妇产科' and fr.card_no is not null and ep.card_no is not null and ep.oper_date&lt;=to_char(r.reg_date,'yyyy-mm-dd hh24:mi') then '产科'
                                       else cdt.pardep_name end dept_name
                                       ,to_char(r.reg_date,'yyyy-mm-dd hh24:mi') reg_date
                                       ,0 amount
                            from  FIN_OPR_REGISTER R 
                            left join com_patientinfo P on p.card_no = r.card_no
                            left join com_department cd on cd.dept_code=r.dept_code
                            left join com_deptstat cdt on  cd.dept_code=cdt.dept_code and cdt.stat_code='00'
                            left join（select  distinct fr.card_no,fr.clinic_code  --B超名单
                                         from fin_opr_register fr ,fin_opb_feedetail f ,com_dictionary cd，com_department cd,com_deptstat cdt
                                        where fr.clinic_code=f.clinic_code 
                                          and fr.valid_flag=1 
                                          and fr.rootdept_first_visit=1 
                                          and f.item_code=cd.code
                                          and f.pay_flag=1 and f.cancel_flag=1
                                          and cd.type='B-mode'
                                          and cd.dept_code=fr.dept_code and cd.dept_code=cdt.dept_code and cdt.stat_code='00' and cdt.pardep_name='妇产科'
                                          and fr.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99
                                     ） fr on fr.card_no=r.card_no and fr.clinic_code=r.clinic_code
                            left join ( select t1.card_no ,min(t1.oper_date) oper_date
                                        from (
                                           select ep.card_no,sum(trans_type) amount,min(ep.oper_date) oper_date
                                             from (
                                                   select distinct ep.card_no,to_char(ep.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                                   ep.invoice_no, 
                                                                   decode(ep.trans_type,1,1,2,-1) trans_type
                                                     from exp_package ep,bd_com_package bp,com_dictionary cd --购买套餐名单
                                                    where ep.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                      and ep.pay_flag=1 
                                                      and ep.package_id=bp.package_id 
                                                      and bp.package_kind=cd.code
                                                      and cd.type='PACKAGETYPE'
                                                      and cd.code in ('1','3','4')
                                                      and bp.package_name not like '%自选包%' and bp.package_name not like '%无痛%' and bp.package_name not like '%赠送%'
                                            )ep group by ep.card_no having sum(trans_type)&lt;&gt;0
                                          union all
                                          select  
                                                  card_no card_no,
                                                  round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2) cashCost,
                                                  min(oper_date) oper_date
                                           from (       
                                                select 
                                                       t3.package_name packagename,
                                                        t.invoice_no invoice_no,
                                                        t.real_cost invoice_real,
                                                        t2.real_cost,
                                                       cp.name,
                                                        to_char(t2.oper_date,'yyyy-mm-dd hh24:mi') oper_date,
                                                        nvl((select sum(a.real_cost)
                                                               from exp_packagepaymode a
                                                              where a.invoice_no = t.invoice_no
                                                                    and a.trans_type = t.trans_type 
                                                                    and (a.mode_code in  ( 'CA','UP','ZB','WP','PO','CD')) ),0) cashCost
                                                        ,case when t3.package_name like '%自选包%' then  0 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then 1 
                                                              when t3.package_name not like '%自选包%' and t2.trans_type=1 then -1 end amount
                                                        ,t7.package_name secondname
                                                        ,t2.card_no 
                                                        ,case when t3.package_name like '%自选包%' then  '自选包' else '套餐' end type
                                                   from exp_packageinvoice t
                                                   left join exp_package t2 on t.invoice_no = t2.invoice_no and t.trans_type=t2.trans_type
                                                   left join bd_com_package t3 on t2.package_id = t3.package_id
                                                   left join bd_com_package t7 on t3.parent_code=t7.package_id
                                                   left join com_patientinfo cp on t2.card_no=cp.card_no
                                                   left join (select * from com_dictionary where type = 'PACKAGETYPE') t4 on t3.package_kind =  t4.code
                                                  where t.oper_date &lt;=to_date('&amp;dtBeginTime','yyyy-mm-dd') 
                                                        and t4.code!='21'
                                                        and t4.code='2'
                                                        and t.trans_type = t2.trans_type
                                             )tt 
                                            group by card_no
                                            having round(sum(case when invoice_real = 0 then 0 else round(cashCost*real_cost/invoice_real,4) end),2)&gt;=1000
                                            )t1 group by t1.card_no
                                            ) ep on r.card_no=ep.card_no
                           where  1 = 1  and  r.rootdept_first_visit = '1' and r.valid_flag = '1' --and r.ynregchrg = '1'
                                  and  r.reg_date between to_date('&amp;dtBeginTime','yyyy-mm-dd')  and to_date('&amp;dtEndTime','yyyy-mm-dd')+0.99)t
                           where dept_name='B超'  )t8 on t1.dept_name=t8.dept_name
             group by t8.amount,t7.card_no 
             )t10
             group by 非套餐B超人数</Sql><AddMapRow>false</AddMapRow><AddMapColumn>false</AddMapColumn><AddMapData>false</AddMapData><AddMapSourceData>false</AddMapSourceData><IsCross>false</IsCross><SqlType>MainReportUsing</SqlType><CrossRows></CrossRows><CrossColumns></CrossColumns><CrossValues></CrossValues><CrossCombinColumns></CrossCombinColumns><SumColumns></SumColumns><CrossGroupColumns></CrossGroupColumns><IsSumRow>true</IsSumRow><SumRows></SumRows><RowGroup /></QueryDataSource></QueryDataSource><QueryFilePath>Report\数据分析\新B超转化率报表设置.xml</QueryFilePath><PrintInfo Type="FS.SOC.HISFC.OutpatientFee.Components.Report.Common.Setting.PrintInfo,SOC.HISFC.OutpatientFee.Components"><PaperSize Type="System.Drawing.Printing.PaperSize,System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"><Height>1169</Height><PaperName>A4</PaperName><RawKind>0</RawKind><Width>850</Width></PaperSize><SelectPage>false</SelectPage></PrintInfo></ReportQueryInfo>